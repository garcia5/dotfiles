#!/bin/bash

function work {
    local session='dev'
    if [ -n "${TMUX}" ]; then
        if tmux list-sessions | grep -q "^$session:"; then
            return
        fi
    fi
    tmux new-session -d -s "$session" -c "$HOME/work" # working session

    # Open in "widescreen" or "normal" mode depending on screen size
    local width
    width=$(tput cols)
    if [ "$width" -gt 300 ]; then
        tmux split-window -h -c "$HOME/work" -l '66%'
    else
        tmux split-window -v -c "$HOME/work" -l '66%'
    fi

    # Keep focus in original pane
    tmux select-pane -t "$session:1.1"
}

function notes {
    local session='notes'
    if [ -n "${TMUX}" ]; then
        if tmux list-sessions | grep -q "^$session:"; then
            return
        fi
    fi

    tmux new-session -d -s "$session" -c "$HOME/notes"
}

function dotfiles {
    local session='dotfiles'
    if [ -n "${TMUX}" ]; then
        if tmux list-sessions | grep -q "^$session:"; then
            return
        fi
    fi

    tmux new-session -d -s "$session" -c "$HOME/dotfiles"
}

function apps {
    open '/Applications/Slack.app/'
    open '/Applications/Obsidian.app/'
    if [ -n "${STARTUP_URLS}" ]; then
        for url in "${STARTUP_URLS[@]}"; do
            open "${url}"
        done
    fi
}

function main {
    dotfiles
    work
    # open slack
    if [[ "$1" == true ]]; then
        apps
    fi

    # no tmux active
    if [[ -z "${TMUX:-}" ]]; then
        tmux attach-session -t 'dev'
        tmux select-pane -t 'dev:1.1'
    fi
}

open_progs=true
for arg in "$@"; do
    if [[ "$arg" == "-q" ]]; then
        open_progs=false
    fi
done

main "$open_progs"
